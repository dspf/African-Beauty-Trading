@model African_Beauty_Trading.Models.ChatRoom
@{
    ViewBag.Title = "Customer Support";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Get the user ID - C# 5 compatible
    var claimsUser = User as System.Security.Claims.ClaimsPrincipal;
    var userIdClaim = claimsUser != null ? claimsUser.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) : null;
    var userId = userIdClaim != null ? userIdClaim.Value : null;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-comments me-2"></i> Customer Service Feedback</h4>
                    <div>
                        <span class="badge bg-light text-dark me-2" id="connection-status">
                            <i class="fas fa-circle text-warning"></i> Connecting...
                        </span>
                        <span class="badge bg-warning text-dark" id="unread-badge">0 unread</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Success/Error Messages -->
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- Chat Container -->
                    <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f8f9fa;">
                        <div id="messages-list">
                            @if (Model.Messages != null && Model.Messages.Any())
                            {
                                foreach (var message in Model.Messages.OrderBy(m => m.SentAt))
                                {
                                    <div class="message @(message.SenderId == userId ? "message-sent" : "message-received")">
                                        <div class="message-header">
                                            <strong>@message.SenderName</strong>
                                            <small class="text-muted">@message.SentAt.ToString("yyyy-MM-dd HH:mm")</small>
                                        </div>
                                        <div class="message-content">@message.Message</div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fa-3x mb-3"></i>
                                    <p>No messages yet. Start a conversation with our support team!</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Message Input -->
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message..." maxlength="500" />
                        <button id="send-button" class="btn btn-primary" disabled>
                            <i class="fas fa-paper-plane me-1"></i> Send
                        </button>
                    </div>

                    <!-- Connection Status -->
                    <div class="mt-2">
                        <small class="text-muted" id="connection-info">
                            <i class="fas fa-info-circle me-1"></i> Connecting to chat...
                        </small>
                    </div>

                    <!-- Debug Tools (remove in production) -->
                    <div class="mt-3 p-2 bg-light rounded d-none" id="debug-panel">
                        <h6 class="mb-2"><i class="fas fa-bug me-1"></i> Debug</h6>
                        <button id="test-connection" class="btn btn-sm btn-warning me-2">
                            <i class="fas fa-bolt me-1"></i> Test
                        </button>
                        <button id="reconnect-btn" class="btn btn-sm btn-info">
                            <i class="fas fa-sync-alt me-1"></i> Reconnect
                        </button>
                        <small class="d-block mt-1" id="debug-info">Room: @Model.Id | User: @userId</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <script>
        $(function () {
            // ===== GLOBAL VARIABLES =====
            var chat = $.connection.chatHub;
            var roomId = @Model.Id;
            var currentUserName = '@User.Identity.Name';
            var currentUserId = '@userId';
            var connectionEstablished = false;
            var reconnectAttempts = 0;
            var maxReconnectAttempts = 5;

            console.log("Initializing chat - Room: " + roomId + ", User: " + currentUserName);

            // ===== SIGNALR CLIENT METHODS =====
            chat.client.receiveMessage = function (sender, message, time) {
                console.log("✓ Received message from: " + sender);
                var isMe = sender === currentUserName;
                addMessageToChat(sender, message, time, isMe);
                updateUnreadCount();
                updateConnectionStatus('connected', 'New message received');
            };

            chat.client.showError = function (errorMessage) {
                console.error("✗ Server error: " + errorMessage);
                showAlert('error', errorMessage);
                updateConnectionStatus('error', errorMessage);
            };

            chat.client.roomJoined = function (joinedRoomId) {
                console.log("✓ Successfully joined room: " + joinedRoomId);
                connectionEstablished = true;
                $('#send-button').prop('disabled', false);
                updateConnectionStatus('connected', 'Ready to chat');
            };

            chat.client.userGroupJoined = function () {
                console.log("✓ Joined user group");
            };

            chat.client.messageSent = function () {
                console.log("✓ Message delivered to server");
            };

            chat.client.testResponse = function (response) {
                console.log("✓ Test response: " + response);
                showAlert('success', 'Connection test passed');
            };

            // ===== CONNECTION MANAGEMENT =====
            function startConnection() {
                console.log("Starting SignalR connection...");
                updateConnectionStatus('connecting', 'Establishing connection...');

                $.connection.hub.start()
                    .done(function () {
                        console.log("✓ Connected to SignalR, Connection ID: " + $.connection.hub.id);
                        console.log("✓ Transport: " + $.connection.hub.transport.name);
                        connectionEstablished = true;
                        reconnectAttempts = 0;
                        joinRoom();
                        updateConnectionStatus('connected', 'Live connection');
                    })
                    .fail(function (error) {
                        console.error("✗ Failed to connect to SignalR: ", error);
                        connectionEstablished = false;
                        $('#send-button').prop('disabled', true);
                        updateConnectionStatus('error', 'Connection failed');

                        // Retry with exponential backoff
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            var delay = Math.min(1000 * reconnectAttempts, 10000);
                            console.log("Retrying connection in " + delay + "ms (attempt " + reconnectAttempts + ")");

                            setTimeout(function() {
                                startConnection();
                            }, delay);
                        } else {
                            showAlert('warning', 'Unable to establish real-time connection. Some features may be limited.');
                        }
                    });
            }

            function joinRoom() {
                if ($.connection.hub.state === $.signalR.connectionState.connected) {
                    console.log("Joining room: " + roomId);

                    // Join the chat room
                    chat.server.joinRoom(roomId).fail(function (error) {
                        console.error("Failed to join room: ", error);
                    });

                    // Join user's personal group
                    chat.server.joinUserGroup(currentUserId).fail(function (error) {
                        console.error("Failed to join user group: ", error);
                    });

                } else {
                    console.log("Cannot join room - not connected");
                }
            }

            // ===== MESSAGE HANDLING =====
            function sendMessage() {
                if (!connectionEstablished) {
                    showAlert('warning', 'Not connected to chat. Please wait...');
                    return;
                }

                var messageInput = $('#message-input');
                var message = messageInput.val().trim();

                if (!message) {
                    showAlert('warning', 'Please enter a message');
                    messageInput.focus();
                    return;
                }

                if (message.length > 500) {
                    showAlert('warning', 'Message is too long (max 500 characters)');
                    return;
                }

                // Disable send button during transmission
                var sendButton = $('#send-button');
                var originalText = sendButton.html();
                sendButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Sending...');

                // Add message to UI immediately (optimistic update)
                var now = new Date();
                var timeString = now.getHours().toString().padStart(2, '0') + ':' +
                               now.getMinutes().toString().padStart(2, '0');
                addMessageToChat(currentUserName, message, timeString, true);

                // Clear input
                messageInput.val('').focus();

                // Send via SignalR
                chat.server.sendMessage(roomId, message, currentUserName, currentUserId, false)
                    .done(function () {
                        console.log("✓ Message sent successfully");
                        sendButton.prop('disabled', false).html(originalText);
                    })
                    .fail(function (error) {
                        console.error("✗ Failed to send message: ", error);
                        showAlert('error', 'Failed to send message: ' + error);
                        sendButton.prop('disabled', false).html(originalText);

                        // Try AJAX fallback
                        sendMessageViaAjax(message);
                    });
            }

            function sendMessageViaAjax(message) {
                console.log("Trying AJAX fallback for message sending");
                $.ajax({
                    url: '@Url.Action("SendMessage", "CustomerChat")',
                    type: 'POST',
                    data: {
                        roomId: roomId,
                        message: message
                    },
                    success: function (response) {
                        if (response.success) {
                            console.log("✓ Message sent via AJAX");
                        } else {
                            console.error("✗ AJAX send failed: " + response.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("✗ AJAX error: " + error);
                    }
                });
            }

            function addMessageToChat(sender, message, time, isMe) {
                // Remove "no messages" placeholder if it exists
                $('.text-center.text-muted').remove();

                var messageClass = isMe ? 'message-sent' : 'message-received';
                var messageHtml =
                    '<div class="message ' + messageClass + '">' +
                    '  <div class="message-header">' +
                    '    <strong>' + sender + '</strong>' +
                    '    <small class="text-muted">' + time + '</small>' +
                    '  </div>' +
                    '  <div class="message-content">' + escapeHtml(message) + '</div>' +
                    '</div>';

                $('#messages-list').append(messageHtml);
                scrollToBottom();

                // Add animation for new messages
                $('.message:last').hide().fadeIn(300);
            }

            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            // ===== UI HELPER FUNCTIONS =====
            function updateConnectionStatus(status, message) {
                var statusElement = $('#connection-status');
                var infoElement = $('#connection-info');

                var statusConfig = {
                    'connected': { class: 'bg-success', icon: 'fa-check-circle', text: 'Connected' },
                    'connecting': { class: 'bg-warning', icon: 'fa-sync-alt fa-spin', text: 'Connecting' },
                    'error': { class: 'bg-danger', icon: 'fa-exclamation-triangle', text: 'Disconnected' }
                };

                var config = statusConfig[status] || statusConfig.error;

                statusElement.removeClass('bg-warning bg-success bg-danger')
                             .addClass(config.class)
                             .html('<i class="fas ' + config.icon + ' me-1"></i> ' + config.text);

                infoElement.html('<i class="fas fa-info-circle me-1"></i> ' + message);
            }

            function showAlert(type, message) {
                // Remove existing alerts
                $('.alert-dismissible').remove();

                var alertClass = type === 'error' ? 'alert-danger' :
                               type === 'warning' ? 'alert-warning' : 'alert-success';

                var alertHtml =
                    '<div class="alert ' + alertClass + ' alert-dismissible fade show mt-2">' +
                    '  <strong>' + (type === 'error' ? 'Error:' : type === 'warning' ? 'Warning:' : 'Success:') + '</strong> ' + message +
                    '  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>';

                $('#chat-container').before(alertHtml);
            }

            function scrollToBottom() {
                var container = $('#chat-container');
                container.animate({ scrollTop: container[0].scrollHeight }, 300);
            }

            function updateUnreadCount() {
                $.get('@Url.Action("GetUnreadCount", "CustomerChat")', function(data) {
                    if (data.unreadCount > 0) {
                        $('#unread-badge').text(data.unreadCount + ' unread').addClass('bg-warning');
                    } else {
                        $('#unread-badge').text('0 unread').removeClass('bg-warning');
                    }
                }).fail(function() {
                    console.error("Failed to get unread count");
                });
            }

            // ===== EVENT HANDLERS =====
            $('#send-button').click(sendMessage);

            $('#message-input').keypress(function (e) {
                if (e.which === 13) { // Enter key
                    sendMessage();
                    return false;
                }
            });

            $('#test-connection').click(function() {
                if (connectionEstablished) {
                    chat.server.testConnection();
                } else {
                    showAlert('warning', 'Not connected to real-time chat');
                }
            });

            $('#reconnect-btn').click(function() {
                reconnectAttempts = 0;
                startConnection();
            });

            // ===== SIGNALR EVENT HANDLERS =====
            $.connection.hub.disconnected(function() {
                console.log("SignalR disconnected");
                connectionEstablished = false;
                $('#send-button').prop('disabled', true);
                updateConnectionStatus('error', 'Disconnected');

                // Auto-reconnect after 2 seconds
                setTimeout(function() {
                    if (!connectionEstablished) {
                        startConnection();
                    }
                }, 2000);
            });

            $.connection.hub.reconnecting(function() {
                console.log("SignalR reconnecting...");
                updateConnectionStatus('connecting', 'Reconnecting...');
            });

            $.connection.hub.reconnected(function() {
                console.log("SignalR reconnected");
                connectionEstablished = true;
                $('#send-button').prop('disabled', false);
                updateConnectionStatus('connected', 'Reconnected');
            });

            // ===== INITIALIZATION =====
            startConnection();
            scrollToBottom();
            updateUnreadCount();

            // Periodic updates
            setInterval(updateUnreadCount, 30000);

            // Focus on input after connection
            setTimeout(function() {
                $('#message-input').focus();
            }, 1000);
        });
    </script>

    <style>
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeInUp 0.3s ease;
        }

        .message-sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message-received {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85em;
        }

            .message-header strong {
                margin-right: 10px;
            }

        .message-content {
            word-wrap: break-word;
            line-height: 1.4;
        }

        #chat-container {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

            #chat-container::-webkit-scrollbar {
                width: 6px;
            }

            #chat-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }

            #chat-container::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }

        #send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}