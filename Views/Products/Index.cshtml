@model IEnumerable<African_Beauty_Trading.Models.Product>

@{
    ViewBag.Title = "Products Management";
}

<div class="container-fluid px-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4 py-3">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Product Management</h1>
            <p class="text-muted mb-0">Manage your product catalog and featured items</p>
        </div>
        <div class="d-flex gap-2">
            @Html.ActionLink("Create New Product", "Create", null, new { @class = "btn btn-primary" })
            @Html.ActionLink("Featured Products", "Featured", null, new { @class = "btn btn-outline-success" })
        </div>
    </div>

    <!-- Products Grid -->
    <div class="card shadow border-0 rounded-3">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-boxes me-2"></i>All Products
                </h5>
                <span class="badge bg-primary fs-6">@Model.Count() Products</span>
            </div>
        </div>

        <div class="card-body p-4">
            @if (!Model.Any())
            {
                <!-- Empty State -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-box-open fa-4x text-muted opacity-50"></i>
                    </div>
                    <h3 class="text-muted mb-3">No Products Found</h3>
                    <p class="text-muted mb-4">Get started by creating your first product.</p>
                    @Html.ActionLink("Create New Product", "Create", null, new { @class = "btn btn-primary btn-lg" })
                </div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var item in Model)
                    {
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm border-0 rounded-4 product-card">
                                <!-- Product Image -->
                                <div class="position-relative">
                                    <img src="@((!string.IsNullOrEmpty(item.ImageUrl)) ? Url.Content(item.ImageUrl) : Url.Content("~/Content/img/placeholder.svg"))"
                                         alt="@item.Name"
                                         class="card-img-top rounded-top-4"
                                         style="height: 220px; object-fit: cover; width: 100%;" />

                                    <!-- Featured Badge -->
                                    <span class="badge @(item.Featured ? "bg-warning text-dark" : "bg-secondary") position-absolute top-0 end-0 m-3 px-3 py-2">
                                        <i class="fas @(item.Featured ? "fa-star" : "fa-circle") me-1"></i>
                                        @(item.Featured ? "Featured" : "Standard")
                                    </span>

                                    <!-- Stock Status Badge -->
                                    <span class="badge @(item.Stock > 10 ? "bg-success" : item.Stock > 0 ? "bg-warning" : "bg-danger") position-absolute top-0 start-0 m-3 px-3 py-2">
                                        <i class="fas fa-box me-1"></i>
                                        @item.Stock in stock
                                    </span>
                                </div>

                                <!-- Product Info -->
                                <div class="card-body d-flex flex-column p-4">
                                    <h5 class="card-title text-dark fw-bold mb-2">@item.Name</h5>

                                    <p class="card-text text-muted small flex-grow-1 mb-3">
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                            if (item.Description.Length > 100)
                                            {
                                                @item.Description.Substring(0, 100)
                                                <text>...</text>
                                            }
                                            else
                                            {
                                                @item.Description
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">No description available</span>
                                        }
                                    </p>

                                    <!-- Price and Category -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="h4 text-primary fw-bold mb-0">R @item.Price.ToString("F2")</span>
                                            @if (item.Category != null)
                                            {
                                                <span class="badge bg-light text-dark border">
                                                    <i class="fas fa-tag me-1"></i>@item.Category.Name
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-light text-muted border">No Category</span>
                                            }
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="btn-group w-100 mb-2" role="group">
                                        @Html.ActionLink("Edit", "Edit", new { id = item.Id },
                                            new { @class = "btn btn-outline-primary btn-sm flex-fill" })
                                        @Html.ActionLink("Details", "Details", new { id = item.Id },
                                            new { @class = "btn btn-outline-info btn-sm flex-fill" })
                                        @Html.ActionLink("Delete", "Delete", new { id = item.Id },
                                            new { @class = "btn btn-outline-danger btn-sm flex-fill" })
                                    </div>

                                    <!-- Quick Feature Toggle -->
                                    <div class="text-center">
                                        <button class="btn btn-sm @(item.Featured ? "btn-warning" : "btn-outline-warning") w-100 toggle-featured"
                                                data-id="@item.Id"
                                                data-featured="@item.Featured.ToString().ToLower()">
                                            <i class="fas fa-star me-1"></i>
                                            @(item.Featured ? "Remove Feature" : "Mark Featured")
                                        </button>
                                    </div>
                                </div>

                                <!-- Footer with Timestamps -->
                                <div class="card-footer bg-transparent border-0 pt-0 px-4 pb-4">
                                    <div class="small text-muted">
                                        <div class="d-flex justify-content-between">
                                            <span>
                                                <i class="fas fa-calendar-plus me-1"></i>
                                                @item.CreatedAt.ToString("MMM dd, yyyy")
                                            </span>
                                            @if (item.UpdatedAt.HasValue)
                                            {
                                                <span>
                                                    <i class="fas fa-edit me-1"></i>
                                                    @item.UpdatedAt.Value.ToString("MMM dd, yyyy")
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Toggle featured status
            $('.toggle-featured').click(function () {
                var button = $(this);
                var productId = button.data('id');
                var isCurrentlyFeatured = button.data('featured') === 'true';

                // Show loading state
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Updating...');

                $.post('@Url.Action("ToggleFeatured", "Products")', { id: productId })
                    .done(function (response) {
                        if (response.success) {
                            // Update button appearance and data
                            if (response.featured) {
                                button.removeClass('btn-outline-warning').addClass('btn-warning');
                                button.html('<i class="fas fa-star me-1"></i> Remove Feature');
                                button.data('featured', 'true');

                                // Update the featured badge on the card
                                var badge = button.closest('.product-card').find('.badge.bg-warning, .badge.bg-secondary');
                                badge.removeClass('bg-secondary').addClass('bg-warning text-dark');
                                badge.html('<i class="fas fa-star me-1"></i> Featured');
                            } else {
                                button.removeClass('btn-warning').addClass('btn-outline-warning');
                                button.html('<i class="fas fa-star me-1"></i> Mark Featured');
                                button.data('featured', 'false');

                                // Update the featured badge on the card
                                var badge = button.closest('.product-card').find('.badge.bg-warning, .badge.bg-secondary');
                                badge.removeClass('bg-warning text-dark').addClass('bg-secondary');
                                badge.html('<i class="fas fa-circle me-1"></i> Standard');
                            }

                            // Show success message
                            if (typeof toastr !== 'undefined') {
                                toastr.success('Product featured status updated successfully');
                            } else {
                                alert('Product featured status updated successfully');
                            }
                        } else {
                            if (typeof toastr !== 'undefined') {
                                toastr.error('Failed to update featured status');
                            } else {
                                alert('Failed to update featured status');
                            }
                        }
                    })
                    .fail(function () {
                        if (typeof toastr !== 'undefined') {
                            toastr.error('Error updating featured status. Please try again.');
                        } else {
                            alert('Error updating featured status. Please try again.');
                        }
                    })
                    .always(function () {
                        // Re-enable button
                        setTimeout(function() {
                            button.prop('disabled', false);
                        }, 1000);
                    });
            });

            // Add hover effects to product cards
            $('.product-card').hover(
                function() {
                    $(this).addClass('shadow-lg').css('transform', 'translateY(-2px)');
                },
                function() {
                    $(this).removeClass('shadow-lg').css('transform', 'translateY(0)');
                }
            );

            // Auto-hide alerts after 5 seconds
            setTimeout(function () {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>

    <style>
        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #e3f2fd;
        }

        .btn-group .btn {
            border-radius: 6px !important;
            margin: 0 2px;
        }

        .card-img-top {
            transition: transform 0.3s ease;
        }

        .product-card:hover .card-img-top {
            transform: scale(1.05);
        }

        .badge {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
    </style>
}