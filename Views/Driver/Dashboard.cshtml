@{
    Layout = "~/Views/Shared/_LayoutDriver.cshtml";
    ViewBag.Title = "Driver Dashboard";
}

<h2 class="mb-4">Driver Dashboard</h2>

<div class="row text-center mb-4">
    <div class="col-md-3">
        <div class="alert alert-warning">
            <h3>Pending</h3>
            <p class="display-6">@ViewBag.PendingCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="alert alert-info">
            <h3>Active</h3>
            <p class="display-6">@ViewBag.ActiveCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="alert alert-success">
            <h3>Completed</h3>
            <p class="display-6">@ViewBag.CompletedCount</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="alert alert-secondary">
            <h3>Returns</h3>
            <p class="display-6">@ViewBag.ReturnCount</p>
        </div>
    </div>
</div>

<hr />

<!-- Pending Assignments: Only paid rental orders not yet accepted -->
<h3 id="pending">Pending Assignments</h3>
@if (ViewBag.PendingAssignments != null && ViewBag.PendingAssignments.Count > 0)
{
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Order #</th>
                <th>Customer Name</th>
                <th>Phone</th>
                <th>Priority</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in ViewBag.PendingAssignments)
            {
                <tr>
                    <td>@assignment.Order.Id</td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>
                                @(assignment.Order.Customer?.FirstName ?? "N/A")
                                @(assignment.Order.Customer?.LastName ?? "")
                            </strong><br />
                        </div>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(assignment.Order.Customer?.PhoneNumber))
                        {
                            @assignment.Order.Customer.PhoneNumber
                        }
                        else
                        {
                            <span class="text-muted">Not provided</span>
                        }
                    </td>
                    <td>
                        @if (assignment.Order.Priority == "Urgent")
                        {
                            <i class="fas fa-flag text-danger" title="Urgent Priority"></i>
                            <span class="text-danger ms-1">Urgent</span>
                        }
                        else
                        {
                            <i class="fas fa-flag text-success" title="Normal Priority"></i>
                            <span class="text-success ms-1">Normal</span>
                        }
                    </td>
                    <td>
                        @using (Html.BeginForm("AcceptAssignment", "Driver", FormMethod.Post, new { style = "display:inline;" }))
                        {
                            @Html.AntiForgeryToken()
                            @Html.Hidden("assignmentId", (int)assignment.Id)
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-check"></i> Accept
                            </button>
                        }
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#declineModal@(assignment.Id)" style="margin-left:5px;">
                            <i class="fas fa-times"></i> Decline
                        </button>
                    </td>
                </tr>

                <!-- Decline Reason Modal -->
                <div class="modal fade" id="declineModal@(assignment.Id)" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            @using (Html.BeginForm("DeclineAssignment", "Driver", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("assignmentId", (int)assignment.Id)

                                <div class="modal-header">
                                    <h5 class="modal-title">Decline Assignment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Order #@assignment.Order.Id - @assignment.Order.Customer?.FirstName @assignment.Order.Customer?.LastName</p>
                                    <div class="form-group">
                                        <label for="declineReason@(assignment.Id)">Reason for declining:</label>
                                        <textarea class="form-control" id="declineReason@(assignment.Id)" name="declineReason" rows="3" required placeholder="Please provide a reason"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Submit Decline</button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No pending assignments at the moment.
    </div>
}

<hr />

<!-- Active Deliveries: Only accepted rental orders not completed/returned -->
<h3 id="active">Active Deliveries</h3>
@if (ViewBag.ActiveDeliveries != null && ViewBag.ActiveDeliveries.Count > 0)
{
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Order #</th>
                <th>Customer Name</th>
                <th>Contact</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in ViewBag.ActiveDeliveries)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>@(order.Customer?.FirstName ?? "N/A") @(order.Customer?.LastName ?? "")</strong>
                        </div>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(order.Customer?.PhoneNumber))
                        {
                            <a href="tel:@order.Customer.PhoneNumber" class="text-decoration-none">
                                <i class="fas fa-phone"></i> @order.Customer.PhoneNumber
                            </a>
                        }
                        else
                        {
                            <span class="text-muted">No phone</span>
                        }
                    </td>
                    <td>
                        <span class="badge @GetStatusBadgeClass(order.DeliveryStatus)">
                            @order.DeliveryStatus
                        </span>
                    </td>
                    <td>
                        <div class="btn-group-vertical">
                            @Html.ActionLink("View Details", "DeliveryDetails", "Driver", new { id = order.Id }, new { @class = "btn btn-primary btn-sm mb-1" })
                            @using (Html.BeginForm("MarkAsArrived", "Driver", FormMethod.Post, new { style = "display:inline;" }))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("orderId", (int)order.Id)
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="fas fa-car"></i> Mark Arrived
                                </button>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No active deliveries at the moment.
    </div>
}

<hr />

<!-- Completed Deliveries: Show delivered/completed orders -->
<h3 id="completed">Completed Deliveries</h3>
@if (ViewBag.CompletedDeliveries != null && ViewBag.CompletedDeliveries.Count > 0)
{
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Order #</th>
                <th>Customer Name</th>
                <th>Contact</th>
                <th>Delivered On</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in ViewBag.CompletedDeliveries)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>@(order.Customer?.FirstName ?? "N/A") @(order.Customer?.LastName ?? "")</strong>
                        </div>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(order.Customer?.PhoneNumber))
                        {
                            @order.Customer.PhoneNumber
                        }
                        else
                        {
                            <span class="text-muted">No phone</span>
                        }
                    </td>
                    <td>@(order.DeliveryDate?.ToString("f") ?? "N/A")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No completed deliveries yet.
    </div>
}

<hr />

<!-- Return Assignments: Only rental orders that require pickup -->
<h3 id="returns">Return Assignments</h3>
@if (ViewBag.ReturnAssignments != null && ViewBag.ReturnAssignments.Count > 0)
{
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Order #</th>
                <th>Customer Name</th>
                <th>Contact</th>
                <th>Pickup Due</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var assignment in ViewBag.ReturnAssignments)
            {
                DateTime? rentEndDate = assignment.Order.RentEndDate;
                var dueMinutes = rentEndDate.HasValue ? (rentEndDate.Value - DateTime.Now).TotalMinutes : 0;
                string dueText = dueMinutes <= 0 ? "Due now" : $"Due in {Math.Round(dueMinutes)} min";
                string dueClass = dueMinutes <= 0 ? "text-danger" : "text-warning";

                <tr>
                    <td>@assignment.Order.Id</td>
                    <td>
                        <div class="d-flex flex-column">
                            <strong>@(assignment.Order.Customer?.FirstName ?? "N/A") @(assignment.Order.Customer?.LastName ?? "")</strong>
                        </div>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(assignment.Order.Customer?.PhoneNumber))
                        {
                            <a href="tel:@assignment.Order.Customer.PhoneNumber" class="text-decoration-none">
                                <i class="fas fa-phone"></i> @assignment.Order.Customer.PhoneNumber
                            </a>
                        }
                        else
                        {
                            <span class="text-muted">No phone</span>
                        }
                    </td>
                    <td class="@dueClass">
                        @dueText
                        <br />
                        <small>@assignment.Order.RentEndDate?.ToString("f")</small>
                    </td>
                    <td>
                        <div class="btn-group-vertical">
                            @using (Html.BeginForm("AcceptReturnAssignment", "Driver", FormMethod.Post, new { style = "display:inline;" }))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("assignmentId", (int)assignment.Id)
                                <button type="submit" class="btn btn-primary btn-sm mb-1">
                                    <i class="fas fa-check"></i> Accept Pickup
                                </button>
                            }
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#returnDeclineModal@(assignment.Id)">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Decline Return Modal -->
                <div class="modal fade" id="returnDeclineModal@(assignment.Id)" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            @using (Html.BeginForm("DeclineAssignment", "Driver", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("assignmentId", (int)assignment.Id)

                                <div class="modal-header">
                                    <h5 class="modal-title">Decline Return Assignment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Return for Order #@assignment.Order.Id</p>
                                    <p>Customer: @assignment.Order.Customer?.FirstName @assignment.Order.Customer?.LastName</p>
                                    <div class="form-group">
                                        <label for="declineReason@(assignment.Id)">Reason for declining:</label>
                                        <textarea class="form-control" id="declineReason@(assignment.Id)" name="declineReason" rows="3" required placeholder="Please provide a reason"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">Submit Decline</button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> No return assignments at the moment.
    </div>
}
@functions {
    public string GetStatusBadgeClass(string status)
    {
        if (string.IsNullOrEmpty(status))
            return "bg-secondary";

        switch (status.ToLower())
        {
            case "pending":
            case "assigned":
                return "bg-warning";
            case "accepted":
            case "processing":
                return "bg-info";
            case "in transit":
            case "arrived":
                return "bg-primary";
            case "delivered":
            case "completed":
                return "bg-success";
            case "cancelled":
            case "declined":
                return "bg-danger";
            default:
                return "bg-secondary";
        }
    }
}

<!-- Add Bootstrap JS for modal functionality -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Auto-close modals after form submission
        $(document).on('submit', 'form', function () {
            $(this).closest('.modal').modal('hide');
        });

        // Enable tooltips
        $(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}

<style>
    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
    }

    .badge {
        font-size: 0.85em;
        padding: 0.5em 0.75em;
    }

    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .alert {
        border: none;
        border-radius: 0.5rem;
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .text-decoration-none:hover {
        text-decoration: underline !important;
    }
</style>