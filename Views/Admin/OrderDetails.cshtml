@model African_Beauty_Trading.Models.Order

@{
    ViewBag.Title = "Order Details";
}

<div class="container mt-4" style="max-width: 1000px;">

    <!-- Order Header -->
    <div class="card shadow-lg border-0 rounded-4 mb-4">
        <div class="card-body">
            <h2 class="fw-bold text-primary mb-3">Order #@Model.Id</h2>

            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> @(Model.Customer != null ? Model.Customer.FirstName : "N/A") @(Model.Customer != null ? Model.Customer.LastName : "")</p>
                    <p><strong>Phone:</strong> @(Model.Customer != null ? Model.Customer.PhoneNumber : "Not provided")</p>
                    <p><strong>Date:</strong> @(Model.OrderDate.HasValue ? Model.OrderDate.Value.ToString("yyyy-MM-dd") : "")</p>
                </div>
                <div class="col-md-6">
                    <p>
                        <strong>Status:</strong>
                        <span class="badge @(Model.PaymentStatus == "Paid" ? "bg-success" : "bg-warning text-dark")"
                              style="font-size:1rem;">
                            @Model.PaymentStatus
                        </span>
                    </p>
                    <p><strong>Total:</strong> <span class="fw-bold text-success">R @Model.TotalPrice.ToString("N2")</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Courier Information -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-header bg-light fw-bold">Courier Information</div>
        <div class="card-body">
            @if (Model.PaymentStatus == "Paid")
            {
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Courier:</strong> @(string.IsNullOrEmpty(Model.CourierName) ? "PEP" : Model.CourierName)</p>
                        <p><strong>Tracking Number:</strong> @(string.IsNullOrEmpty(Model.CourierTrackingNumber) ? "Not assigned yet" : Model.CourierTrackingNumber)</p>
                        <p>
                            <strong>Status:</strong>
                            <span class="badge @GetStatusBadgeClass(Model.CourierStatus)">
                                @(string.IsNullOrEmpty(Model.CourierStatus) ? "Processing" : Model.CourierStatus)
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Shipped Date:</strong> @(Model.ShippedDate.HasValue ? Model.ShippedDate.Value.ToString("yyyy-MM-dd") : "Not shipped yet")</p>
                        <p><strong>Estimated Delivery:</strong> @(Model.EstimatedDeliveryDate.HasValue ? Model.EstimatedDeliveryDate.Value.ToString("yyyy-MM-dd") : "Not available")</p>
                        <p><strong>Delivery Date:</strong> @(Model.DeliveryDate.HasValue ? Model.DeliveryDate.Value.ToString("yyyy-MM-dd") : "Not delivered yet")</p>
                    </div>
                </div>

                <hr />

                <!-- Update Courier Status Form -->
                using (Html.BeginForm("UpdateCourierStatus", "Admin", FormMethod.Post, new { @class = "mt-3" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="orderId" value="@Model.Id" />

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Courier Status</label>
                            <select name="courierStatus" class="form-select">
                                <option value="Processing" @(Model.CourierStatus == "Processing" ? "selected" : "")>Processing</option>
                                <option value="Ready for Pickup" @(Model.CourierStatus == "Ready for Pickup" ? "selected" : "")>Ready for Pickup</option>
                                <option value="Shipped" @(Model.CourierStatus == "Shipped" ? "selected" : "")>Shipped</option>
                                <option value="In Transit" @(Model.CourierStatus == "In Transit" ? "selected" : "")>In Transit</option>
                                <option value="Out for Delivery" @(Model.CourierStatus == "Out for Delivery" ? "selected" : "")>Out for Delivery</option>
                                <option value="Delivered" @(Model.CourierStatus == "Delivered" ? "selected" : "")>Delivered</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tracking Number</label>
                            <input type="text" name="trackingNumber" class="form-control" value="@Model.CourierTrackingNumber" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estimated Delivery</label>
                            <input type="date" name="estimatedDelivery" class="form-control" value="@(Model.EstimatedDeliveryDate.HasValue ? Model.EstimatedDeliveryDate.Value.ToString("yyyy-MM-dd") : "")" />
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Update Status</button>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-warning">
                    Courier information will be available after payment is confirmed.
                </div>
            }
        </div>
    </div>

    <!-- Items Table -->
    <div class="card shadow-sm border-0 rounded-4 mb-4">
        <div class="card-header bg-light fw-bold">Order Items</div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price (Each)</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.OrderItems)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-light rounded p-2 me-3">
                                        <i class="fas fa-box-open text-muted" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>@item.Product.Name</strong>
                                        @if (!string.IsNullOrEmpty(item.Product.Description))
                                        {
                                            <br />
                                            <small class="text-muted">@item.Product.Description</small>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>@item.Quantity</td>
                            <td>R @item.Price.ToString("N2")</td>
                            <td>R @((item.Quantity * item.Price).ToString("N2"))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-end">
        @Html.ActionLink("Back to Orders", "Orders", null, new { @class = "btn btn-secondary" })
    </div>
</div>

@functions {
    public string GetStatusBadgeClass(string status)
    {
        if (string.IsNullOrEmpty(status))
            return "bg-secondary";

        switch (status)
        {
            case "Processing": return "bg-secondary";
            case "Ready for Pickup": return "bg-info";
            case "Shipped": return "bg-primary";
            case "In Transit": return "bg-warning text-dark";
            case "Out for Delivery": return "bg-info";
            case "Delivered": return "bg-success";
            default: return "bg-secondary";
        }
    }
}