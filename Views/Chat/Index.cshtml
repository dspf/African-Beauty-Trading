@model African_Beauty_Trading.Models.ChatRoom

@{
    ViewBag.Title = "Customer Support";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-chat-dots"></i> Customer Support</h4>
                </div>
                <div class="card-body">
                    <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                        <div id="messages-list">
                            @foreach (var message in Model.Messages.OrderBy(m => m.SentAt))
                            {
                                <div class="message @(message.SenderId == User.Identity.Name ? "message-sent" : "message-received")">
                                    <div class="message-header">
                                        <strong>@message.SenderName</strong>
                                        <small class="text-muted">@message.SentAt.ToString("yyyy-MM-dd HH:mm")</small>
                                    </div>
                                    <div class="message-content">@message.Message</div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message..." />
                        <button id="send-button" class="btn btn-primary">Send</button>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Our support team will respond as soon as possible.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/signalr/hubs"></script>

    <script>
        $(function () {
            var chat = $.connection.chatHub;
            var roomId = @Model.Id;

            // Register to receive messages
            chat.client.receiveMessage = function (sender, message, time) {
                var isMe = sender === '@User.Identity.Name';
                var messageClass = isMe ? 'message-sent' : 'message-received';

                var messageHtml = '<div class="message ' + messageClass + '">' +
                    '<div class="message-header">' +
                    '<strong>' + sender + '</strong>' +
                    '<small class="text-muted">' + time + '</small>' +
                    '</div>' +
                    '<div class="message-content">' + message + '</div>' +
                    '</div>';

                $('#messages-list').append(messageHtml);
                scrollToBottom();
            };

            // Start connection - CUSTOMER VERSION (no joinAdminGroup)
            $.connection.hub.start().done(function () {
                chat.server.joinRoom(roomId);

                $('#send-button').click(function () {
                    var message = $('#message-input').val();
                    if (message.trim() !== '') {
                        chat.server.sendMessage(roomId, message, '@User.Identity.Name');
                        $('#message-input').val('');
                    }
                });

                $('#message-input').keypress(function (e) {
                    if (e.which === 13) {
                        $('#send-button').click();
                    }
                });
            });

            function scrollToBottom() {
                var container = $('#chat-container');
                container.scrollTop(container[0].scrollHeight);
            }

            scrollToBottom();
        });
    </script>

    <style>
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }

        .message-sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message-received {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

            .message-header strong {
                margin-right: 10px;
            }

        .message-content {
            word-wrap: break-word;
        }
    </style>
}