@using Microsoft.AspNet.Identity
@model African_Beauty_Trading.Models.ChatRoom
@{
    ViewBag.Title = "Chat with " + Model.CustomerName;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // Get user ID using claims - C# 5 compatible
    var claimsUser = User as System.Security.Claims.ClaimsPrincipal;
    var userIdClaim = claimsUser != null ? claimsUser.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) : null;
    var userId = userIdClaim != null ? userIdClaim.Value : null;
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-comments me-2"></i>Chat with @Model.CustomerName
            </h4>
            <div>
                <span class="badge bg-light text-dark" id="connection-status">
                    <i class="fas fa-circle text-secondary"></i> Not Connected
                </span>
            </div>
        </div>
        <div class="card-body">
            <!-- Connection Panel -->
            <div class="alert alert-info" id="connection-panel">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="alert-heading mb-1"><i class="fas fa-plug me-2"></i>Connect to Chat</h6>
                        <p class="mb-0">Click the button below to join the real-time chat with @Model.CustomerName</p>
                    </div>
                    <button id="join-chat-button" class="btn btn-success btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i> Join Chat
                    </button>
                </div>
            </div>

            <!-- Chat Messages Container -->
            <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa; display: none;">
                <div id="messages-list">
                    @if (!Model.Messages.Any())
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    }
                    else
                    {
                        foreach (var message in Model.Messages.OrderBy(m => m.SentAt))
                        {
                            <div class="@(message.SenderId == userId ? "text-end" : "text-start") mb-2">
                                <div class="d-inline-block p-2 rounded @(message.SenderId == userId ? "bg-primary text-white" : "bg-light border")" style="max-width: 70%;">
                                    <small>
                                        <strong>@message.SenderName</strong>
                                        <span class="ms-2">@message.SentAt.ToString("HH:mm")</span>
                                        @if (message.SenderId != userId && !message.IsRead)
                                        {
                                            <span class="badge bg-success ms-1">New</span>
                                        }
                                    </small>
                                    <br>
                                    <span class="message-text">@message.Message</span>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Message Input Area (Hidden until connected) -->
            <div id="message-input-area" style="display: none;">
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." maxlength="500">
                    <button id="send-button" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i> Send
                    </button>
                </div>
                <small class="text-muted mt-1 d-block">Press Enter to send</small>
            </div>

            <!-- Debug Information -->
            <div class="mt-3 p-2 bg-light rounded">
                <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i> Connection Info</h6>
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>Room ID:</strong> @Model.Id</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Customer:</strong> @Model.CustomerName</small>
                    </div>
                </div>
                <div class="mt-1">
                    <small><strong>Status:</strong> <span id="debug-status">Waiting for connection...</span></small>
                </div>
                <div class="mt-2">
                    <button id="reconnect-button" class="btn btn-warning btn-sm me-2" style="display: none;">
                        <i class="fas fa-sync-alt me-1"></i> Reconnect
                    </button>
                    <button id="test-button" class="btn btn-info btn-sm" style="display: none;">
                        <i class="fas fa-bolt me-1"></i> Test
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!-- Use ASP.NET Core SignalR client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

    <script>
        (function () {
            var connection = null;
            var roomId = @Model.Id;
            var userName = '@User.Identity.Name';
            var userId = '@userId';
            var isConnected = false;
            var groupsJoined = false;

            console.log("Chat room initialized. Room:", roomId, "User:", userName);
            console.log("Waiting for manual connection...");

            function addMessageToChat(sender, message, time, isMe) {
                $('.text-center.text-muted').remove();

                var alignment = isMe ? 'text-end' : 'text-start';
                var bgColor = isMe ? 'bg-primary text-white' : 'bg-light border';

                var messageHtml =
                    '<div class="' + alignment + ' mb-2 message-item">' +
                    '  <div class="d-inline-block p-2 rounded ' + bgColor + '" style="max-width: 70%;">' +
                    '    <small><strong>' + escapeHtml(sender) + '</strong> ' +
                    '    <span class="ms-2">' + escapeHtml(time) + '</span></small>' +
                    '    <br>' +
                    '    <span class="message-text">' + escapeHtml(message) + '</span>' +
                    '  </div>' +
                    '</div>';

                $('#messages-list').append(messageHtml);
                scrollToBottom();

                // Visual feedback
                $('.message-item:last').hide().fadeIn(300);
            }

            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return (text || '').toString().replace(/[&<>"']/g, function (m) { return map[m]; });
            }

            function scrollToBottom() {
                var container = $('#chat-container');
                container.animate({ scrollTop: container[0].scrollHeight }, 200);
            }

            function updateConnectionStatus(status, message) {
                var statusElement = $('#connection-status');
                var debugElement = $('#debug-status');

                var statusConfig = {
                    'connected': { class: 'bg-success', icon: 'fa-check-circle', text: 'Connected' },
                    'connecting': { class: 'bg-warning', icon: 'fa-sync-alt fa-spin', text: 'Connecting' },
                    'error': { class: 'bg-danger', icon: 'fa-exclamation-triangle', text: 'Error' },
                    'disconnected': { class: 'bg-secondary', icon: 'fa-plug', text: 'Not Connected' }
                };

                var config = statusConfig[status] || statusConfig.disconnected;

                statusElement.removeClass('bg-warning bg-success bg-danger bg-secondary')
                             .addClass(config.class)
                             .html('<i class="fas ' + config.icon + ' me-1"></i> ' + config.text);

                debugElement.text(message);
            }

            function showChatInterface() {
                $('#connection-panel').fadeOut(300, function () {
                    $('#chat-container').fadeIn(400);
                    $('#message-input-area').fadeIn(400);
                    $('#reconnect-button').show();
                    $('#test-button').show();
                });
                $('#send-button').prop('disabled', false);
                setTimeout(function () { $('#message-input').focus(); }, 500);
                scrollToBottom();
            }

            function startConnection() {
                updateConnectionStatus('connecting', 'Connecting to server...');
                $('#join-chat-button').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Connecting...');

                connection = new signalR.HubConnectionBuilder()
                    .withUrl('/chathub')
                    .withAutomaticReconnect()
                    .build();

                connection.on('receiveMessage', function (sender, message, time) {
                    addMessageToChat(sender, message, time, sender === userName);
                    updateConnectionStatus('connected', 'New message');
                });

                connection.on('roomJoined', function (joinedRoomId) {
                    groupsJoined = true;
                    showChatInterface();
                    updateConnectionStatus('connected', 'Ready to chat');
                });

                connection.on('adminJoined', function () {
                    console.log('Admin joined');
                });

                connection.on('messageSent', function () {
                    console.log('Message delivered');
                });

                connection.on('testResponse', function (response) {
                    console.log('Test response:', response);
                });

                connection.start().then(function () {
                    isConnected = true;
                    // Join room and admin group after connected
                    connection.invoke('JoinRoom', roomId).catch(function (err) { console.error(err.toString()); });
                    connection.invoke('JoinAdminGroup').catch(function (err) { console.error(err.toString()); });
                }).catch(function (err) {
                    console.error('Connection failed: ', err.toString());
                    updateConnectionStatus('error', 'Connection failed');
                    $('#join-chat-button').prop('disabled', false).html('<i class="fas fa-sign-in-alt me-2"></i> Join Chat');
                });
            }

            function sendMessage() {
                if (!isConnected || !groupsJoined) { alert('Please connect to the chat first'); return; }
                var messageInput = $('#message-input');
                var message = messageInput.val().trim();
                if (!message) { alert('Please enter a message'); messageInput.focus(); return; }

                var button = $('#send-button');
                var originalText = button.html();
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

                var now = new Date();
                var timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                addMessageToChat(userName, message, timeString, true);
                messageInput.val('').focus();

                connection.invoke('SendMessage', roomId, message, userName, userId, true)
                    .then(function () { button.prop('disabled', false).html(originalText); })
                    .catch(function (err) { console.error('Send failed:', err.toString()); button.prop('disabled', false).html(originalText); alert('Failed to send: ' + err.toString()); });
            }

            $('#join-chat-button').click(function () { startConnection(); });
            $('#send-button').click(sendMessage);
            $('#message-input').keypress(function (e) { if (e.which === 13) { sendMessage(); return false; } });
            $('#reconnect-button').click(function () { if (connection) { connection.start(); } else { startConnection(); } });
            $('#test-button').click(function () { if (connection) { connection.invoke('TestConnection'); } else { alert('Not connected'); } });

            // Initial state
            updateConnectionStatus('disconnected', 'Click "Join Chat" to connect');
        })();
    </script>

    <style>
        .message-text { word-wrap: break-word; }
        #chat-container { scrollbar-width: thin; scrollbar-color: #c1c1c1 #f1f1f1; }
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        #chat-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .message-item { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #connection-panel { border-left: 4px solid #0dcaf0; }
    </style>
}